---
title: "TARGET fusion analysis"
author: "bhaas"
date: '2022-08-16'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


```{r}

target_sample_info = read.table("../data/TARGETdb.sample_info.tsv", sep="\t", header=T, stringsAsFactors = F)

target_sample_info = target_sample_info %>% mutate(tumor_or_normal = ifelse(grepl("Normal", sample_type), "normal", "tumor"))

target_sample_info$project = str_replace(target_sample_info$project, "TARGET-", "")
target_sample_info$project = str_replace(target_sample_info$project, "ALL-P[\\d]", "ALL")

target_project_sample_counts = target_sample_info %>% select(sample, project, tumor_or_normal) %>% unique() %>% 
  group_by(project, tumor_or_normal) %>%  tally(name='total_sample_count') %>% arrange(project, desc(total_sample_count))


target_project_sample_counts

```

```{r}

target_sample_info %>% nrow()
# 1366 samples

target_sample_info %>% select(participant) %>% unique() %>% nrow()
# 1230 participants

```

# STARF results

```{r}

STARF_data = read.table(gzfile("../data/STAR-Fusion.v1.10.0.TARGETdb.tsv.gz"),
                           header=T, sep="\t", stringsAsFactors = F)


STARF_data$fusion_name = str_replace(STARF_data$fusion_name, "--", "::")

## some initial cleanup
STARF_data = STARF_data %>% 
  filter(! grepl("chrM", annots)) %>%
  filter(! grepl("HLA", fusion_name)) %>%
  filter(! (grepl("^IG[HKVL]", LeftGene) & grepl("^IG[HKVL]", RightGene)))


# set primary isoform
STARF_data = STARF_data %>% group_by(sample, fusion_name) %>% arrange(desc(FFPM)) %>% mutate(is_primary = (row_number()==1) ) %>% ungroup()


# add sample info
STARF_data = left_join(STARF_data, target_sample_info, by='sample')

cosmic_fusions = read.table("../data/cosmic.list")[,1]
STARF_data = STARF_data %>% mutate(cosmic = (fusion_name %in% cosmic_fusions))


```




```{r}

# how many STAR-F fusions variants
STARF_data %>% select(sample, fusion_name) %>% nrow()
# 228612

# how many STAR-F fusion occurrences

STARF_data %>% filter(is_primary) %>% select(sample, fusion_name)  %>% nrow()
# 213786

```



# FI results

```{r}

# input data

FI_data = read.table(gzfile("../data/FusionInspector.v2.4.0.TARGET.tsv.gz"), sep="\t", com='', header=T, stringsAsFactors = F)

FI_data = FI_data %>% 
  filter(! grepl("chrM", annots)) %>%
  filter(! grepl("HLA", fusion_name)) %>%
  filter(! (grepl("^IG[HKVL]", LeftGene) & grepl("^IG[HKVL]", RightGene)))


FI_data = left_join(FI_data, target_sample_info, by='sample')

```


```{r}


# how many FI fusions variants
FI_data %>% select(sample, fusion_name) %>% nrow()
# 217614

# how many FI fusion occurrences

FI_data %>% filter(is_primary) %>% select(sample, fusion_name)  %>% nrow()
# 182807

```


182807 / 213786 = 0.86

so, 86% of the STAR-F identified fusions were further 'in silico validated' by FusionInspector.


# COSMIC fusions in TARGET w/ comparison to TCGA

```{r}



TARGET_cosmic_fusion_sample_counts = STARF_data %>% filter(cosmic & is_primary) %>% select(participant, project, tumor_or_normal, fusion_name) %>% unique() %>% group_by(project, tumor_or_normal, fusion_name) %>% tally(name='sample_count_w_fusion')

TARGET_cosmic_fusion_sample_counts = left_join(TARGET_cosmic_fusion_sample_counts, target_project_sample_counts, by=c('project', 'tumor_or_normal'))


TARGET_cosmic_fusion_sample_counts = TARGET_cosmic_fusion_sample_counts %>% mutate(sample_type_frac = sample_count_w_fusion / total_sample_count)


fusion_name_sum_sample_counts = TARGET_cosmic_fusion_sample_counts %>% group_by(fusion_name) %>% summarize(sum_samples = sum(sample_count_w_fusion))

TARGET_cosmic_fusion_sample_counts = left_join(TARGET_cosmic_fusion_sample_counts, fusion_name_sum_sample_counts, by='fusion_name')

TARGET_cosmic_fusion_sample_counts %>% arrange(desc(sample_type_frac))
```


```{r}


TARGET_cosmic_fusion_sample_counts %>% ggplot(aes(x=reorder(fusion_name, -sum_samples), y=sample_count_w_fusion, fill=project)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```


```{r}


TARGET_cosmic_fusion_sample_counts %>% ggplot(aes(x=reorder(fusion_name, -sum_samples), y=sample_type_frac, fill=project)) + geom_col() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
   theme(panel.border = element_blank(), 
             panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), 
             axis.line = element_line(colour = "black"))


```



```{r}

# examine our earlier TCGA / COSMIC results:

tcga_gtex_stats = read.table(gzfile("../data/TCGA_n_GTEx.STAR-Fusion.v1.7.fusion_preds.stats.tsv.gz"), header=T, sep="\t", stringsAsFactors = F)

tcga_gtex_stats = tcga_gtex_stats %>% filter(fusion_name %in% cosmic_fusions) 

cosmic_fusion_sample_counts = bind_rows(TARGET_cosmic_fusion_sample_counts %>% select(project, fusion_name, sample_count_w_fusion), 
                                        
                                        tcga_gtex_stats %>% filter(tumor>0) %>% 
                                          mutate(project="TCGA") %>% 
                                          select(project, fusion_name, sample_count_w_fusion = tumor)
                                        ) 

```


```{r}

cosmic_fusion_sample_counts = cosmic_fusion_sample_counts %>% mutate(in_TCGA = (fusion_name %in% tcga_gtex_stats$fusion_name)) 

```


```{r}
cosmic_fusion_sample_counts  %>% 
  ggplot(aes(x=reorder(fusion_name, in_TCGA), y=project, fill=log(sample_count_w_fusion+1))) + geom_tile() + 
  theme_bw() +
   scale_fill_continuous(high = "#132B43", low = "#56B1F7", na.value="white") +
       theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
       theme(panel.border = element_blank(), 
             panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), 
             axis.line = element_line(colour = "black"))

                                        
```
                             
```{r}

# which cosmic fusions are unique to TARGET set as compared to TCGA

cosmic_fusion_sample_counts %>% filter(! fusion_name %in% tcga_gtex_stats$fusion_name) %>%
  ggplot(aes(x=fusion_name, y=project, fill=log(sample_count_w_fusion+1))) + geom_tile() + 
  
   theme_bw() +
   scale_fill_continuous(high = "#132B43", low = "#56B1F7", na.value="white") +
       theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
       theme(panel.border = element_blank(), 
             panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), 
             axis.line = element_line(colour = "black")) +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))
                                        


```








