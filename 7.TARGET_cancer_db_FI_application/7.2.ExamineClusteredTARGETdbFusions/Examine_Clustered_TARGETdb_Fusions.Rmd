---
title: "Examine_Clustered_TARGETdb_Fusions"
author: "bhaas"
date: '2022-09-04'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggrepel)
library(pheatmap)
library(cowplot)
library(ggforce)

```


```{r}

data = read.table(gzfile("../../data/FusionInspector.v2.4.0.TARGET.decorated.tsv.gz"), header=T, sep="\t", stringsAsFactors = F)

```


```{r}
# general stats on cluster predictions

data %>% group_by(fusion_cluster_att) %>% tally() %>%  mutate(pct=prop.table(n)*100)

```




```{r}
#############################
# merge the tumor or normal samples per patient, select the highest expressed fusion variant as representative
#############################

nrow(data)

data = data %>% group_by(participant, fusion_name, LeftBreakpoint, RightBreakpoint, tumor_or_normal) %>%
  arrange(desc(FFPM)) %>%
  filter(row_number() == 1) %>%
  ungroup()


# can restrict to only n primary fusion occurrences to examine how it impacts our findings.
# data = data %>% filter(is_primary) %>% group_by(fusion_name) %>% filter(row_number() <= 3) %>% ungroup()

nrow(data)
```





```{r}

umap.layout.cent = data %>% filter(! is.na(umap1)) %>% 
  select(umap1, umap2, leiden) %>% group_by(leiden) %>% summarize_all(mean)

```


```{r}

umap_plot = data %>% filter(! is.na(umap1)) %>%
  ggplot(aes(x=umap1, y=umap2)) + 
  geom_point(alpha = 0.3, size=0.05, aes(color=factor(leiden))) + theme_bw() +
  xlim(quantile(data$umap1, c(0.005, 0.995), na.rm = T)) +
  ylim(quantile(data$umap2, c(0.005, 0.995), na.rm=T))  +
  geom_label_repel(data=umap.layout.cent, aes(label = leiden), max.overlaps = Inf) + 
                             guides(colour = FALSE)


plot(umap_plot)
```




```{r}

# highlight the cosmic entries

cosmic_subset = data %>% filter(cosmic == TRUE & is_primary)

p = umap_plot + geom_point(data=cosmic_subset, color='black')

plot(p)


```


```{r}

ggsave(p, file="TARGETdb_umap_plot.pdf", width=12, height=10)


```




```{r}


max_cluster = max(data$leiden)

all_median_vals_df = NULL

data.scaled = data[, grepl("^adj", colnames(data))]


for (cluster_i in seq(max_cluster)) {

    #message("cluster: ", cluster_i)
    
    cluster_row_indices = which(data$leiden == cluster_i)
    
    feature_atts = data.scaled[cluster_row_indices,]
    
    median_vals = as_tibble(feature_atts) %>% gather() %>% group_by(key) %>% summarize(m=median(value))

    df = data.frame(median_vals$m, row.names=median_vals$key)
    df = as.data.frame(t(df))
    df$cluster = cluster_i

    all_median_vals_df = bind_rows(all_median_vals_df, df)

}


rownames(all_median_vals_df) = all_median_vals_df$cluster

all_median_vals_df = all_median_vals_df[,!c(colnames(all_median_vals_df)=='cluster')]

```



```{r}

median_vals_pca = prcomp(t(all_median_vals_df))
rows_d = dist(median_vals_pca$rotation[,1:6])
rowclust = hclust(as.dist(rows_d), "ward.D")


cols_d = dist(t(all_median_vals_df))

colclust = hclust(as.dist(cols_d), "ward.D")



p = pheatmap(all_median_vals_df, 
             cluster_rows=rowclust,
             cluster_cols=colclust,
             )


```

plot cosmic primary isoform fusion counts according to cluster

```{r}


cosmic_counts_per_cluster = cosmic_subset %>%
    group_by(fusion_name, leiden) %>% 
    tally()

cosmic_counts_per_cluster$leiden = factor(cosmic_counts_per_cluster$leiden, levels=rev(p$tree_row$labels[p$tree_row$order]))

empty_counts_df = data.frame(fusion_name="NA", leiden=factor(seq(max_cluster), levels=rev(p$tree_row$labels[p$tree_row$order])), n=0)

cosmic_counts_per_cluster = bind_rows(empty_counts_df, cosmic_counts_per_cluster)



# plot it


cosmic_primary_fusion_counts_per_cluster_plot = cosmic_counts_per_cluster %>% ggplot(aes(x=leiden, y=n, fill=fusion_name)) + geom_col() + coord_flip() + ggtitle("COSMIC primary isoform count") +
    theme_bw() +
            theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


plot(cosmic_primary_fusion_counts_per_cluster_plot)
```


```{r}

# without colors

cosmic_sum_counts_per_cluster = cosmic_counts_per_cluster %>% group_by(leiden) %>% summarize(sum_n = sum(n))


cosmic_sum_counts_per_cluster_plot = cosmic_sum_counts_per_cluster %>% ggplot(aes(x=leiden, y=sum_n)) + geom_col() + coord_flip() + ggtitle("COSMIC primary isoform count") +
    theme_bw() +
            theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))



plot(cosmic_sum_counts_per_cluster_plot)


```





```{r}

# examine breakdown of all fusion variant calls (not just occurrences)

all_fusion_variant_counts_per_cluster = data %>% 
    select(fusion_name, leiden) %>% 
    group_by(fusion_name, leiden) %>% 
    tally() %>% ungroup()

high_FAR_artifact_clusters = c(71,79,78)
RT_artifact_clusters = c(73, 77)

ARTIFACT_CLUSTERS = c(high_FAR_artifact_clusters, RT_artifact_clusters)


frac_variant_cluster_predictions = all_fusion_variant_counts_per_cluster %>% mutate(cluster_type = ifelse(leiden==21, "COSMIC-like", "Other")) %>%
  mutate(cluster_type = ifelse(leiden %in% high_FAR_artifact_clusters, "high_FAR", cluster_type) ) %>%
  mutate(cluster_type = ifelse(leiden %in% RT_artifact_clusters, "RT_artifact", cluster_type) )

frac_variant_cluster_predictions %>% group_by(cluster_type) %>% mutate(sum_n = sum(n)) %>% select(cluster_type, sum_n) %>% unique() %>% ungroup() %>%
  mutate(pct=prop.table(sum_n))


# 1.6% cosmic-like
# 1.2% artifact-like

```


```{r}

# all fusions, top isoforms


top_fusion_counts_per_cluster = data %>% 
    filter(is_primary) %>%
    select(fusion_name, leiden) %>% 
    group_by(fusion_name, leiden) %>% 
    tally()

top_fusion_counts_per_cluster$leiden = factor(top_fusion_counts_per_cluster$leiden, levels=rev(p$tree_row$labels[p$tree_row$order]))

empty_counts_df = data.frame(fusion_name="NA", leiden=factor(seq(max_cluster), levels=rev(p$tree_row$labels[p$tree_row$order])), n=0)


top_fusion_counts_per_cluster = bind_rows(empty_counts_df, top_fusion_counts_per_cluster)

sum_fusion_counts_per_cluster = top_fusion_counts_per_cluster %>% group_by(leiden) %>% summarize(sum_n = sum(n))

sum_fusion_counts_per_cluster_plot = sum_fusion_counts_per_cluster %>% ggplot(aes(x=leiden, y=sum_n)) + geom_col() + coord_flip() + ggtitle("Fusion primary isoform count") +
    theme_bw() +
            theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

plot(sum_fusion_counts_per_cluster_plot)
```

plot cosmic enrichment per cluster

```{r}

cosmic_sum_counts_per_cluster$fusion_type = "cosmic"
sum_fusion_counts_per_cluster$fusion_type = "all"
cosmic_and_all_counts_df = bind_rows(cosmic_sum_counts_per_cluster, sum_fusion_counts_per_cluster)

cosmic_and_all_counts_df = cosmic_and_all_counts_df %>% spread(key=fusion_type, value=sum_n)
cosmic_and_all_counts_df = cosmic_and_all_counts_df %>% mutate(frac_cosmic = cosmic/all)

cosmic_frac_enrichment_plot = cosmic_and_all_counts_df %>% ggplot(aes(x=leiden, y=frac_cosmic)) + 
    geom_col() + coord_flip() + ggtitle("Fraction COSMIC fusions") +
    theme_bw() +
            theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

plot(cosmic_frac_enrichment_plot)
```


Create single summary plot

```{r}


cosmic_sum_counts_per_cluster_plot_NoLegend = cosmic_sum_counts_per_cluster_plot + 
    theme(legend.position = "none")

pg = plot_grid(p[[4]], cosmic_sum_counts_per_cluster_plot_NoLegend, sum_fusion_counts_per_cluster_plot, cosmic_frac_enrichment_plot, 
          nrow=1, rel_widths = c(3,1,1,1) )

plot(pg)

```


```{r}

ggsave(pg, file="TARGETdb_heatmap_collage_plot.pdf", width=20, height=13)

```


```{r}

frac_cluster_predictions = data %>% filter(is_primary) %>% group_by(leiden, fusion_cluster_att) %>% tally() %>%
  mutate(pct=prop.table(n)) 

#empty_counts_df = data.frame(leiden=factor(seq(max_cluster), levels=rev(p$tree_row$labels[p$tree_row$order])), pct=0, fusion_cluster_att=NA)

#frac_cluster_predictions = bind_rows(empty_counts_df, frac_cluster_predictions)


frac_cluster_predictions$leiden = factor(frac_cluster_predictions$leiden, levels=rev(p$tree_row$labels[p$tree_row$order]))

frac_cluster_att_predictions_plot = frac_cluster_predictions  %>%
  mutate(pct = ifelse(is.na(fusion_cluster_att ), 0, pct)) %>%
  ggplot(aes(x=leiden, y=pct, fill=fusion_cluster_att)) + geom_col() + coord_flip() +
    theme_bw() +
            theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


plot(frac_cluster_att_predictions_plot)

```

```{r}

cosmic_sum_counts_per_cluster_plot_NoLegend = cosmic_sum_counts_per_cluster_plot + 
    theme(legend.position = "none")

pg = plot_grid(p[[4]], cosmic_sum_counts_per_cluster_plot_NoLegend, sum_fusion_counts_per_cluster_plot, cosmic_frac_enrichment_plot, 
               frac_cluster_att_predictions_plot + theme(legend.position = "none"),
          nrow=1, rel_widths = c(3,1,1,1,1) )

plot(pg)


```


```{r}

ggsave(pg, file="target_cluster_main_fig.pdf", width=12, height=8)

```


```{r}

# examine breakdown of fusion occurrences according to cluster groups

frac_cluster_predictions = frac_cluster_predictions %>% mutate(cluster_type = ifelse(leiden==21, "COSMIC-like", "Other")) %>%
  mutate(cluster_type = ifelse(leiden %in% high_FAR_artifact_clusters, "high_FAR", cluster_type) ) %>%
  mutate(cluster_type = ifelse(leiden %in% RT_artifact_clusters, "RT_artifact", cluster_type) )

frac_cluster_predictions %>% group_by(cluster_type) %>% mutate(sum_n = sum(n)) %>% select(cluster_type, sum_n) %>% unique() %>% ungroup() %>%
  mutate(pct=prop.table(sum_n))

# 1.7% cosmic-like occurrences
# 0.7% artifact-like occurrences

```







# Examine COSMIC enrichment stat significance

```{r}

# combine into single table and examine fraction cosmic fusions per cluster

cosmic_counts_by_cluster = full_join(cosmic_sum_counts_per_cluster %>% select(leiden, sum_cosmic = sum_n), 
                                     sum_fusion_counts_per_cluster %>% select(leiden, sum_fusions = sum_n) , by='leiden')


total_cosmic = cosmic_counts_by_cluster %>% summarize(tot_cosmic = sum(sum_cosmic), tot_fusions = sum(sum_fusions))

cosmic_counts_by_cluster = cosmic_counts_by_cluster  %>% mutate(frac_cosmic = sum_cosmic / sum_fusions)

cosmic_counts_by_cluster = bind_cols(cosmic_counts_by_cluster, total_cosmic)

cosmic_counts_by_cluster %>% arrange(desc(sum_cosmic))

```


```{r}

# statistical significance of COSMIC fusion enrichment




run_fishers_exact_test = function(cosmic_count, fusion_count, tot_cosmic_fusions, total_fusions) {
    
    message("cosmic_count: ", cosmic_count)
    message("fusion count: ", fusion_count)
  
    
    non_cosmic_count = fusion_count - cosmic_count
    tot_noncosmic_fusions  = total_fusions - tot_cosmic_fusions
    
    confusion_matrix = matrix(c(cosmic_count, non_cosmic_count,
                                tot_cosmic_fusions - cosmic_count, tot_noncosmic_fusions - non_cosmic_count),
                              nrow=2, byrow = T)    
    print(confusion_matrix)
    
    f = fisher.test(confusion_matrix, alternative = 'greater')
    
    return(f$p.value)
    
}


cosmic_counts_by_cluster = cosmic_counts_by_cluster  %>% rowwise() %>% mutate(
  pval = run_fishers_exact_test(
         sum_cosmic, sum_fusions, tot_cosmic, tot_fusions)
)  %>% mutate(negLOGp = -1 * log10(pval))


cosmic_counts_by_cluster %>% arrange(desc(negLOGp))


```

```{r}
cosmic_counts_by_cluster %>% ggplot(aes(x=leiden, y=negLOGp)) + geom_col() +
  ggtitle("TARGET COSMIC fusion enrichment per predicted clusters") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



```

```{r}
cosmic_counts_by_cluster$pval_BH = p.adjust(cosmic_counts_by_cluster$pval, method="BH")

cosmic_counts_by_cluster %>% arrange(pval_BH)

# cluster 21, adj pval = 3.7e-151
```

# Examine COSMIC and COSMIC-like fusions in cluster 21

```{r}

COSMIC_cluster = "21"


data %>% filter(cosmic & is_primary) %>% group_by(fusion_name, sample_type) %>%  tally() %>%
  ggplot(aes(x=fusion_name, y=n, fill=sample_type)) + geom_col() +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


```{r}
# examine cosmic fusions according to the clusters they fall in

data %>% filter(is_primary & cosmic) %>% group_by(fusion_name, leiden) %>% tally() %>%
  ggplot(aes(x=fusion_name, y=n, fill=factor(leiden))) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



```



```{r}

all_cosmic_fusions = data %>% filter(cosmic) %>% select(fusion_name) %>% unique() %>% pull(fusion_name)

fusion_sample_type_counts = data %>% 
  filter(is_primary) %>% 
  group_by(fusion_name, project, tumor_or_normal) %>% 
  tally(name='fusion_sample_type_counts')

sample_type_counts = data %>% select(sample, project, tumor_or_normal) %>% unique() %>% group_by(project, tumor_or_normal) %>% tally(name='sample_type_counts')

fusion_sample_type_counts = left_join(fusion_sample_type_counts, sample_type_counts, by=c('project', 'tumor_or_normal'))


fusion_sample_type_counts = fusion_sample_type_counts %>% mutate(sample_type_frac = fusion_sample_type_counts / sample_type_counts)

fusion_sample_type_counts = fusion_sample_type_counts %>% mutate(cosmic = (fusion_name %in% all_cosmic_fusions))


```



```{r}

# examine cosmic fusions according to sample type representation

# nothing in normal
fusion_sample_type_counts %>% filter(cosmic & tumor_or_normal == "normal") %>% ggplot(aes(x=fusion_name, y=sample_type_frac, fill=project)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


# plot tumor
fusion_sample_type_counts %>% filter(cosmic & tumor_or_normal == "tumor") %>% ggplot(aes(x=fusion_name, y=sample_type_frac, fill=project)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```



```{r}

# how many cosmic fusions above?
data %>% filter(cosmic) %>% select(fusion_name ) %>% unique() %>% nrow()
# 30

```



```{r}

# how many COSMC fusions are represented by C21?

data %>% filter(leiden == COSMIC_cluster) %>% filter(cosmic) %>% select(fusion_name) %>% unique() 

# 22

```

# Examine FAR for C21-containing COSMIC fusions

```{r}

cosmic_fusions_in_C21 = data %>% filter(leiden == 21 & is_primary & cosmic) %>% select(fusion_name) %>% unique() %>% pull(fusion_name)

cosmic_FAR_data = data %>% filter(fusion_name %in% cosmic_fusions_in_C21) %>% 
  filter(leiden==21 & is_primary) %>%
  rename("5p-FAR" = FAR_left, "3p-FAR" = FAR_right ) %>%
  gather(key=FAR_type, value=FAR_val, "5p-FAR", "3p-FAR") %>%
  mutate(FAR_type=factor(FAR_type, levels=c("5p-FAR", "3p-FAR"))) 

cosmic_FAR_data %>%
  ggplot(aes(x=FAR_type, y=FAR_val)) + geom_boxplot() + facet_wrap(~fusion_name, scale='free_y')




```

```{r}

cosmic_FAR_data %>%
  ggplot(aes(x=FAR_type, y=FAR_val, fill=FAR_type)) + 
  geom_violin(scale='width') +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1))) + 
  facet_wrap(~fusion_name, scale='free_y') +  
  geom_jitter(size=rel(0.1)) +
  theme(strip.text.x = element_text(size = rel(0.8)))


```

```{r}

cosmic_paired_FAR_data = cosmic_FAR_data %>% select(sample, fusion_name, FAR_type, FAR_val) %>% spread(key=FAR_type, value=FAR_val)

cosmic_fusions_here = cosmic_paired_FAR_data %>% select(fusion_name) %>% unique() %>% pull(fusion_name)

cosmic_FAR_test_pvals = NULL

for (cosmic_fusion_select in cosmic_fusions_here) {
  
  paired_FAR_data = cosmic_paired_FAR_data %>% filter(fusion_name == cosmic_fusion_select)
  
  left_FAR_vals = paired_FAR_data %>% pull(`5p-FAR`)
  right_FAR_vals = paired_FAR_data %>% pull(`3p-FAR`)
  
  if (length(left_FAR_vals) >= 3 && length(right_FAR_vals) >= 3) {
    t = t.test(left_FAR_vals, right_FAR_vals, alternative = 'less', paired = T)
    w = wilcox.test(left_FAR_vals, right_FAR_vals, alternative = 'less', paired = T)
    cosmic_FAR_test_pvals = bind_rows(cosmic_FAR_test_pvals, data.frame(fusion=cosmic_fusion_select, tp_val = t$p.value, wp_val = w$p.value))
    
    }
}


cosmic_FAR_test_pvals$tp_val_BH = p.adjust(cosmic_FAR_test_pvals$tp_val, method = 'BH')
cosmic_FAR_test_pvals$wp_val_BH = p.adjust(cosmic_FAR_test_pvals$wp_val, method = 'BH')

cosmic_FAR_test_pvals

```



```{r}
cosmic_FAR_test_pvals = cosmic_FAR_test_pvals %>% mutate(signif = tp_val < 0.05)

cosmic_FAR_test_pvals %>% 
  mutate(negLogP = -1*log10(tp_val)) %>%
  ggplot(aes(x=fusion, y=negLogP, fill=signif)) + geom_col() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1))) +
  ggtitle("t-Test uncorrected")

cosmic_FAR_test_pvals = cosmic_FAR_test_pvals %>% mutate(signif = tp_val_BH < 0.05)

cosmic_FAR_test_pvals %>% 
  mutate(negLogP = -1*log10(tp_val_BH)) %>%
  ggplot(aes(x=fusion, y=negLogP, fill=signif)) + geom_col() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1))) +
  ggtitle("t-Test corrected")

cosmic_FAR_test_pvals =  cosmic_FAR_test_pvals %>% mutate(signif = wp_val < 0.05)

cosmic_FAR_test_pvals %>% 
   mutate(negLogP = -1*log10(wp_val)) %>%
  ggplot(aes(x=fusion, y=negLogP, fill=signif)) + geom_col() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1))) +
  ggtitle("Wilcoxon test uncorrected")

cosmic_FAR_test_pvals =  cosmic_FAR_test_pvals %>% mutate(signif = wp_val_BH < 0.05)

cosmic_FAR_test_pvals %>% 
   mutate(negLogP = -1*log10(wp_val_BH)) %>%
  ggplot(aes(x=fusion, y=negLogP, fill=signif)) + geom_col() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(1))) +
  ggtitle("Wilcoxon test corrected")

```


Signal there, but overall not as impressive as what we observed with TCGA. Still curious...



#####################################################################################################################################


############################################
# Explore new potential fusions of interest
############################################

- exclude those found in normals here
- rank by tumor sample fractions and proportion in C21


```{r}

fusions_found_in_normals = data %>% filter(tumor_or_normal == "normal") %>% select(fusion_name) %>% unique() %>% pull(fusion_name)

length(fusions_found_in_normals)
# 1036
```

```{r}

# examine fraction of fusions found in C21

fusion_fraction_C21 = data %>% filter(is_primary) %>%  
  group_by(fusion_name, sorted_fusion_name, annots, leiden) %>% 
  tally(name='count_in_C21') %>% 
  mutate(frac_leiden_C21=prop.table(count_in_C21)) %>% 
  filter(leiden==COSMIC_cluster) %>%
  ungroup()

fusion_fraction_C21
```



```{r}

# examine fraction of *COSMIC* fusion instances found in C21

fusion_fraction_C21  = fusion_fraction_C21 %>% mutate(cosmic = (fusion_name %in% all_cosmic_fusions) )

fusion_fraction_C21 %>% filter(cosmic) %>% arrange(frac_leiden_C21) %>% select(-annots)

# min of 10% here

```



```{r}

# get total fusion abundance across TARGET samples
fusion_all_sample_counts = data %>% filter(is_primary) %>% group_by(fusion_name) %>% tally(name='tot_sample_count_w_fusion')

fusion_fraction_C21 = left_join(fusion_fraction_C21, fusion_all_sample_counts, by='fusion_name')


fusion_fraction_C21 %>% select(-c(sorted_fusion_name, annots))
```





```{r}

# combine with earlier tcga/gtex occurrence stats
tcga_gtex_fusion_stats = read.table(gzfile("../../data/TCGA_n_GTEx.STAR-Fusion.v1.7.fusion_preds.stats.tsv.gz"), header=T, sep="\t", stringsAsFactors = F)


fusion_fraction_C21  = left_join(fusion_fraction_C21, tcga_gtex_fusion_stats, by='fusion_name')
 
fusion_fraction_C21 %>%  select(-c(sorted_fusion_name, annots))
```

```{r}

# examine the cosmic-here set wrt our earlier tcga/gtex findings

fusion_fraction_C21 %>% filter(cosmic) %>% arrange(desc(count_in_C21)) %>%  select(-c(sorted_fusion_name, annots))


```


```{r}

write.table(fusion_fraction_C21 %>% filter(cosmic) %>% arrange(desc(count_in_C21)), file="C21_cosmic_entries.tsv", quote=F, sep="\t", row.names = F)

```



```{r}

fusion_fraction_artifact_clusters = data %>% filter(is_primary) %>%  
  mutate(in_artifact_cluster = (leiden %in% ARTIFACT_CLUSTERS) ) %>%

  group_by(fusion_name, in_artifact_cluster ) %>% 
  tally(name='count_in_artcluster') %>% 
  mutate(frac_artcluster=prop.table(count_in_artcluster)) %>% 
  ungroup() %>% 
  filter(in_artifact_cluster)

fusion_fraction_artifact_clusters


```




# select top new candidates

```{r}

# find some new candidates of interest

top_new_candidates = fusion_fraction_C21 %>%  
  filter(! fusion_name %in% fusions_found_in_normals) %>%
  filter(tot_sample_count_w_fusion >= 3) %>%
  filter(normal == 0 | is.na(normal) | cosmic) %>%
  arrange(desc(tot_sample_count_w_fusion))


top_new_candidates  %>% select(-c(sorted_fusion_name, annots))
```



```{r}

# incorporate the sample type fractions

top_new_candidates = left_join(top_new_candidates, fusion_sample_type_counts,  by=c('fusion_name', 'cosmic' ) )

top_new_candidates  %>%  select(-c(sorted_fusion_name, annots))
```




```{r}
sum_frac = top_new_candidates %>% 
  select(fusion_name, tot_sample_count_w_fusion, cosmic, sample_type_frac, project) %>% 
  unique() %>%
  group_by(fusion_name) %>% 
  mutate(sum_frac = sum(sample_type_frac)) %>% 
  select(fusion_name, sum_frac) %>% 
  unique()

top_new_candidates = left_join(top_new_candidates, sum_frac, by='fusion_name')
 
```


```{r}

candidates_sample_frac_plot = top_new_candidates  %>% 
  #group_by(fusion_name, project) %>% arrange(desc(sample_type_frac) %>% filter(row_number()==1) %>% ungroup() %>%
  ggplot(aes(x=reorder(fusion_name, -sum_frac), y=sample_type_frac, fill=project)) + geom_col() +  
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

candidates_sample_frac_plot 

```


```{r}

# indicate if in cosmic or not

cosmic_entries_plot = top_new_candidates %>% select(fusion_name, sum_frac, cosmic) %>% unique() %>%
  mutate(cosmic = ifelse(cosmic, TRUE, NA)) %>% 
  ggplot(aes(x=reorder(fusion_name, -sum_frac), y=TRUE, fill=cosmic)) + 
  geom_tile() +
  theme_bw() +
            theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
            theme(axis.title.y=element_blank(), axis.text.y = element_blank(), axis.ticks.y=element_blank()) +
            scale_fill_manual(na.value="white", values="purple") +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

cosmic_entries_plot 



```









```{r}

# examine reciprocal translocations for C21


# define fusion gene pairs found in C21 samples
C21_fusion_containing_samples_n_sorted_fusions =  data %>% filter(leiden==COSMIC_cluster) %>% select(sample, sorted_fusion_name) %>% unique() 


# define the reciprocal fusions among these
# - restricted to C21 samples
# - the fusion_name A::B and B::A must show up in the same sample
reciprocal_fusions_data = left_join( data, C21_fusion_containing_samples_n_sorted_fusions, by=c('sample', 'sorted_fusion_name')) %>%
       filter(is_primary) %>%
       group_by(sample, fusion_name, sorted_fusion_name) %>% unique() %>% group_by(sample, sorted_fusion_name) %>% tally() %>% filter(n>1) %>% ungroup()

# capture both A::B and B::A occurrences of fusions for these samples.
reciprocal_fusions_data = left_join(reciprocal_fusions_data, 
                                    data, 
                                    by=c('sample', 'sorted_fusion_name'))



# now further restrict to those fusions among our top candidates as earlier defined.
top_new_candidate_sorted_fusions = top_new_candidates %>% select(sorted_fusion_name) %>% unique() %>% pull(sorted_fusion_name)

reciprocal_fusions_data = reciprocal_fusions_data %>% filter(sorted_fusion_name %in% top_new_candidate_sorted_fusions)

reciprocal_fusions_data %>% filter(is_primary) %>% arrange(sample, sorted_fusion_name)




```

```{r}


top_new_candidates = left_join(top_new_candidates, 
                               reciprocal_fusions_data %>% filter(leiden == COSMIC_cluster) %>% select(fusion_name, partnerA, partnerB) %>% 
                                 unique() %>% mutate(reciprocal_fusion = TRUE),
                               by='fusion_name')

top_new_candidates %>% filter(reciprocal_fusion) %>% arrange(sorted_fusion_name, fusion_name)

```

```{r}

reciprocal_fusion_plot = top_new_candidates %>% select(fusion_name, sum_frac, reciprocal_fusion) %>% unique() %>%
  ggplot(aes(x=reorder(fusion_name, -sum_frac), y=TRUE, fill=reciprocal_fusion)) + 
  geom_tile() +
  theme_bw() +
            theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
            theme(axis.title.y=element_blank(), axis.text.y = element_blank(), axis.ticks.y=element_blank()) +
            scale_fill_manual(na.value="white", values="blue")  +
   theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

reciprocal_fusion_plot

```




```{r}


# examine fusion sample correlation matrix for only the reciprocal fusion subset

#fusion_reciprocal_sample_C21_info = data %>% 
#  filter(is_primary & 
#           sorted_fusion_name %in% reciprocal_fusions_data$sorted_fusion_name & 
#           sorted_fusion_name %in% top_new_candidates$sorted_fusion_name) %>% 
#  select(fusion_name, project, sample, sorted_fusion_name) %>% unique() 

#write.table(fusion_reciprocal_sample_C21_info %>% select(project, fusion_name) %>% unique(), 
#  file="C21_project_fusion.reciprocal.info.tsv", quote=F, sep="\t", col.names=F, row.names=F)


write.table(reciprocal_fusions_data %>% select(project, fusion_name) %>% unique(), 
  file="C21_project_fusion.reciprocal.info.tsv", quote=F, sep="\t", col.names=F, row.names=F)



write.table(reciprocal_fusions_data %>% select(fusion_name, sample) %>%  mutate(found=1) %>% unique() %>% spread(key=sample, value=found, fill=0),
            file="C21_project_fusion.reciprocal.sample_matrix.tsv", quote=F, sep="\t", row.names=F)


fusion_sample_matrix = read.table("C21_project_fusion.reciprocal.sample_matrix.tsv", row.names=1, header=T, sep="\t")
write.table(t(fusion_sample_matrix), file="C21_project_fusion.reciprocal.sample_matrix.tsv", quote=F, sep="\t", row.names=T)


# Make the sample correlation plot like so using PtR:
# trinityrnaseq/Analysis/DifferentialExpression/PtR -m C21_project_fusion.reciprocal.sample_matrix.tsv -s C21_project_fusion.reciprocal.info.tsv --heatmap --sample_cor_matrix --img_width 20 --img_height 20


```



```{r}
# include annotation for a gene partner among the known set of ALL driver genes

ALL_driver_genes = read.table("../ALL.cancer_driver_genes.list", header=T, sep="\t")[,1]


top_new_candidates  = top_new_candidates  %>% 
  mutate(contains_ALL_driver_gene = (partnerA %in% ALL_driver_genes | partnerB %in% ALL_driver_genes) )

# indicate if includes an ALL cancer gene or not

ALL_drivers_plot = top_new_candidates  %>% select(fusion_name, sum_frac, contains_ALL_driver_gene) %>% unique() %>%
  mutate(contains_ALL_driver_gene = ifelse(contains_ALL_driver_gene, TRUE, NA)) %>% 
  ggplot(aes(x=reorder(fusion_name, -sum_frac), y=TRUE, fill=contains_ALL_driver_gene)) + 
  geom_tile() +
  theme_bw() +
            theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
            theme(axis.title.y=element_blank(), axis.text.y = element_blank(), axis.ticks.y=element_blank()) +
            scale_fill_manual(na.value="white", values="cyan") +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

ALL_drivers_plot 



```


# Want COSMIC-like cluster stats and frame change stats too.



```{r}

top_new_candidate_fusions = top_new_candidates %>% select(fusion_name) %>% unique() %>% pull(fusion_name)


cosmic_like_pred_data = data %>% filter(fusion_name %in% top_new_candidate_fusions) %>% filter(is_primary) %>% 
  mutate(fusion_cluster_att = ifelse(is.na(fusion_cluster_att), "Other", fusion_cluster_att)) %>% 
  group_by(fusion_name, fusion_cluster_att) %>% tally() %>% mutate(frac_fusions=prop.table(n))

cosmic_like_pred_data
```


```{r}


cosmic_like_pred_data = bind_rows(cosmic_like_pred_data %>% select(fusion_name, fusion_cluster_att, frac_fusions),
          top_new_candidates %>% select(fusion_name, frac_fusions = frac_leiden_C21) %>% 
            unique() %>% 
            mutate(fusion_cluster_att = "frac_in_C21") )

cosmic_like_pred_data 

```

```{r}

cosmic_like_pred_data = bind_rows(cosmic_like_pred_data,
                                  fusion_fraction_artifact_clusters %>% 
                                    filter(fusion_name %in%  top_new_candidates$fusion_name) %>%
                                    select(fusion_name, frac_fusions = frac_artcluster) %>% mutate(fusion_cluster_att = "artifactCluster" ) ) 
                                    
                                
```

```{r}


cosmic_like_pred_data$fusion_cluster_att = factor(cosmic_like_pred_data$fusion_cluster_att, levels=rev(c('Other', 'COSMIC-like', 'expr_microH_RT_artifact?', "artifactCluster", 'frac_in_C21')))


cosmic_like_pred_plot = left_join(cosmic_like_pred_data, sum_frac) %>% 
  filter(fusion_cluster_att %in% c('Other', 'COSMIC-like', 'frac_in_C21')) %>% # only useful here
  ggplot(aes(x=reorder(fusion_name, -sum_frac), y=fusion_cluster_att, fill=frac_fusions)) +
        geom_tile() +
        theme_bw() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
        ylab("Cluster Type") +
        theme(axis.text.y = element_text(size=rel(0.7)))  +
        scale_fill_continuous(high = "#132B43", low = "#56B1F7", na.value="white") +
         theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

cosmic_like_pred_plot

```


```{r}

fusion_coding_effects = read.table(gzfile("../../data/fusions.coding_effects.abridged.tsv.gz"), header=T, sep="\t", stringsAsFactors = F)


```


```{r}

candidate_fusion_coding_data = left_join(data %>% filter(is_primary) %>% filter(fusion_name %in% top_new_candidate_fusions),
                                         fusion_coding_effects,
                                         by=c('fusion_name', 'LeftBreakpoint', 'RightBreakpoint'))

candidate_fusion_coding_data 
```

```{r}

candidate_fusion_coding_frac_data = candidate_fusion_coding_data %>% select(fusion_name, PROT_FUSION_TYPE, sample) %>% 
  mutate(PROT_FUSION_TYPE = ifelse(PROT_FUSION_TYPE==".", "Other", PROT_FUSION_TYPE)) %>% 
  group_by(fusion_name, PROT_FUSION_TYPE) %>% 
  tally() %>% 
  mutate(frac_fusions=prop.table(n)) 

candidate_fusion_coding_frac_plot = left_join(candidate_fusion_coding_frac_data, sum_frac) %>%  
  ggplot(aes(x=reorder(fusion_name, -sum_frac), y=PROT_FUSION_TYPE, fill=frac_fusions)) +
        geom_tile() +
        theme_bw() +
        theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
        ylab("Cluster Type") +
        theme(axis.text.y = element_text(size=rel(0.7)))  +
        scale_fill_continuous(high = "#132B43", low = "#56B1F7", na.value="white")  +
         theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


candidate_fusion_coding_frac_plot
```




```{r}
# chromosome structure


top_new_candidates = left_join(top_new_candidates, 
                                 data %>% select(fusion_name, structure_type) %>% unique(),
                                 by='fusion_name')

chrom_structure_plot =  top_new_candidates %>% 
  select(fusion_name, structure_type, sum_frac)  %>% 
  unique() %>%
    ggplot(aes(x=reorder(fusion_name, -sum_frac), y=0, fill=structure_type)) +
  geom_tile() +
   theme_bw() +
       theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),
          axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()
          ) +
 
         theme(panel.border = element_blank(), panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

chrom_structure_plot

```




```{r}
# combine plots into a single figure


pg = plot_grid(cosmic_like_pred_plot,
               candidate_fusion_coding_frac_plot,
               chrom_structure_plot,
               cosmic_entries_plot,
               ALL_drivers_plot,
               reciprocal_fusion_plot,
               candidates_sample_frac_plot,
                 ncol=1,
                 align='v',
                 axis='lr',
                 rel_heights = c(0.2, 0.2, 0.15, 0.15, 0.15, 0.15,0.70)
                 )


plot(pg)


```

```{r}

ggsave(pg, file="TARGET_summary_plot.pdf", height=8, width=14)


```

```{r}

# Make the short list:

top_new_candidates_top_sample_frac = top_new_candidates %>% group_by(fusion_name) %>% 
  arrange(desc(sum_frac)) %>%
  filter(row_number()==1) %>%
  ungroup() %>%
  select(fusion_name, tot_sample_count_w_fusion, sum_frac, frac_leiden_C21, cosmic, normal, tumor, logTN, project, annots, structure_type, sorted_fusion_name) %>%
  arrange(desc(sum_frac))


top_new_candidates_top_sample_frac

```



```{r}
write.table(top_new_candidates_top_sample_frac, file="TARGET.cosmic-like_candidates.tsv", quote=F, sep="\t", row.names = F)

```



```{r}


blood_each_sample_type_heatmap = top_new_candidates %>% 

 ggplot(aes(x=reorder(fusion_name, -sum_frac), y=project)) +
        geom_tile(aes(fill=sample_type_frac)) +
        facet_col(vars(project), , scales = "free_y", space = "free") +

         theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
        ylab("sample_type") +
        xlab("fusion") +
        theme_bw() +
        theme(axis.text.y = element_text(size=rel(1)))  +
        scale_fill_continuous(high = "#132B43", low = "#56B1F7", na.value="white") +
        scale_x_discrete(expand = c(0, 0)) +    
        scale_y_discrete(expand = c(0, 0)) +  
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

plot(blood_each_sample_type_heatmap)

```

```{r}
ggsave(blood_each_sample_type_heatmap, file="blood_each_sample_type_heatmap.pdf", width=15, height=8)

```


```{r}
blood_top_sample_type_heatmap = top_new_candidates %>%

 ggplot(aes(x=reorder(fusion_name, -sum_frac), y=reorder(project, desc(project)))) +
        geom_tile(aes(fill=sample_type_frac)) +

#         theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
#+
        ylab("sample_type") +
        xlab("fusion") +
        theme_bw() +
#        theme(axis.text.y = element_text(size=rel(1)))  +
        scale_fill_continuous(high = "#132B43", low = "#56B1F7", na.value="white") +
       theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
       theme(panel.border = element_blank(), 
             panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(), 
             axis.line = element_line(colour = "black"))


plot(blood_top_sample_type_heatmap )
```




```{r}


pg = plot_grid(cosmic_like_pred_plot,
               candidate_fusion_coding_frac_plot,
               chrom_structure_plot,
               cosmic_entries_plot,
               ALL_drivers_plot,
               reciprocal_fusion_plot,
               blood_top_sample_type_heatmap ,
                 ncol=1,
                 align='v',
                 axis='lr',
                 rel_heights = c(0.2, 
                                  0.2, 
                                  0.15, 
                                  0.1, 
                                  0.1, 
                                  0.1,
                                  0.70)
                 )


plot(pg)

```





```{r}
ggsave(pg, file="TARGET.cosmic-like_candidates.pdf", width=18, height=12)

```


```{r}

fusion_sample_type_counts %>% filter(fusion_name == "TCF3::PBX1")


```

```{r}

# auditing count of top_new_candidates
top_new_candidates %>% select(fusion_name) %>% unique() %>% nrow()
# 108

# how many of the top candidates involve an aLL candidate driver gene?
top_new_candidates %>% filter(contains_ALL_driver_gene) %>% select(fusion_name) %>% unique()  %>% nrow()
# 28

# and how many of these have evidence of a reciprocal fusion?

top_new_candidates %>% filter(contains_ALL_driver_gene & reciprocal_fusion) %>% select(fusion_name) %>% unique()  %>% nrow()

# all ALL-driver-gene containing fusions have evidence of recprocal fusions

# 28/108 = 26% 
```

```{r}
# counting C21 fusions
data %>% filter(leiden == 21) %>% filter (is_primary) %>% nrow()
# 3091

data %>% filter(leiden == 21) %>% filter (is_primary) %>% select(fusion_name) %>% unique() %>% nrow()
# 910

```

